# 八丈島位置制限機能 実装ドキュメント

## 概要

このシステムでは、ユーザーの地理的位置に基づいて機能を制限しています。八丈島内からのアクセスでのみ利用できる機能があり、島民向けのローカルコミュニティサービスとして設計されています。

## 制限される機能

### 🚫 八丈島外では利用不可

1. **投稿作成** (`/new`)
   - 新規投稿の作成
   - 画像アップロード
   - 投稿フォームへのアクセス

2. **仕事情報** (`/?category=仕事`)
   - 仕事カテゴリの投稿閲覧
   - 仕事カテゴリボタンの選択

3. **島民限定機能**
   - 緊急投稿機能
   - ご近所助け合い機能
   - 本土発送代行機能

### ✅ 全ユーザーが利用可能

- 掲示板の閲覧（仕事以外のカテゴリ）
- 不動産・不用品カテゴリの投稿閲覧

## 位置判定の仕組み

### 地理的境界
```
北緯: 33.045° ~ 33.155°
東経: 139.74° ~ 139.81°
中心座標: 33.1067°N, 139.7853°E
```

### 判定方法
1. **GPS位置情報**: ブラウザのGeolocation APIを使用
2. **IPアドレス位置情報**: GPS拒否時のフォールバック
3. **キャッシュ**: 1時間のローカルストレージキャッシュ

## 実装レイヤー

### フロントエンド制限
- **コンポーネント表示制御**: `useLocation` hookによる条件分岐
- **ページアクセス制御**: `AccessDenied` コンポーネント
- **UI状態管理**: ボタン無効化、メッセージ表示

### バックエンド制限
- **API Route検証**: `/api/posts` での位置情報検証
- **データベース制限**: RLS (Row Level Security) ポリシー
- **位置情報記録**: 投稿時の座標保存

## セキュリティ対策

### 多層防御
1. **フロントエンド**: UIレベルでの制限
2. **API Layer**: サーバーサイドでの検証
3. **Database**: RLSポリシーによる制限

### 記録・監査
- 投稿作成時の位置座標記録
- 位置確認済みフラグ
- エラーログの保存

## ファイル構成

```
src/
├── components/
│   ├── LocationRestrictionStatus.tsx    # 位置制限状況表示
│   ├── LocationStatus.tsx               # 位置情報ステータス
│   ├── AccessDenied.tsx                # アクセス拒否画面
│   ├── IslanderFeatures.tsx            # 島民限定機能
│   └── LocationTester.tsx              # テスト用コンポーネント
├── hooks/
│   └── useLocation.ts                  # 位置情報管理フック
├── lib/
│   └── geolocation.ts                  # 位置判定ロジック
├── app/
│   ├── api/posts/route.ts              # API Route（位置検証付き）
│   ├── new/page.tsx                    # 投稿作成ページ
│   ├── test/page.tsx                   # テストページ
│   └── page.tsx                        # メインページ
└── sql/
    ├── supabase-setup.sql              # 初期スキーマ
    └── update-schema-location.sql      # 位置情報カラム追加
```

## テスト方法

### 手動テスト
1. `/test` ページにアクセス
2. LocationTesterコンポーネントで座標を変更
3. 各機能の制限状況を確認

### プリセット座標
- **八丈島中心**: 33.1067, 139.7853 ✅
- **八丈島境界**: 33.155, 139.81 ✅
- **東京**: 35.6762, 139.6503 ❌
- **横浜**: 35.4437, 139.6380 ❌

### 確認項目
- [ ] 位置情報取得の動作
- [ ] 八丈島内外の正しい判定
- [ ] 制限機能のUI表示/非表示
- [ ] 投稿作成の制限
- [ ] API Routeでの検証
- [ ] エラーメッセージの表示

## 注意事項

### 開発時
- 開発環境では位置情報取得が制限される場合があります
- HTTPSが必要な場合があります（本番環境）
- ブラウザの位置情報許可が必要です

### 本番環境
- GPS精度の問題を考慮してください
- VPNや位置偽装への対策を検討してください
- プライバシーポリシーでの位置情報利用説明が必要です

## 今後の拡張可能性

- より詳細な地域区分
- 時間帯による制限
- 島民認証システムとの連携
- 位置情報の精度向上
- 不正アクセスの検知・防止

## トラブルシューティング

### よくある問題
1. **位置情報が取得できない**
   - ブラウザの設定確認
   - HTTPS接続の確認
   - 位置情報許可の確認

2. **制限が正しく動作しない**
   - フロントエンドとバックエンドの実装確認
   - データベースのRLS設定確認
   - 座標計算ロジックの確認

3. **テストで八丈島外判定される**
   - 座標の入力値確認
   - 境界値の設定確認
   - 計算式の精度確認